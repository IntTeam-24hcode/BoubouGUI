<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Generating JavaScript</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks/logic.js"></script>
  <script src="../../blocks/loops.js"></script>
  <script src="../../blocks/math.js"></script>
  <script src="../../blocks/text.js"></script>
  <script src="../../blocks/lists.js"></script>
  <script src="../../blocks/colour.js"></script>
  <script src="../../blocks/variables.js"></script>
  <script src="../../blocks/procedures.js"></script>
  <script src="../../blocks/nosFonctions.js"></script>
  <script src="../../generators/python.js"></script>
  <script src="../../generators/python/logic.js"></script>
  <script src="../../generators/python/loops.js"></script>
  <script src="../../generators/python/math.js"></script>
  <script src="../../generators/python/text.js"></script>
  <script src="../../generators/python/lists.js"></script>
  <script src="../../generators/python/colour.js"></script>
  <script src="../../generators/python/variables.js"></script>
  <script src="../../generators/python/nosFonctions.js"></script>
  <script src="../../generators/python/procedures.js"></script>
  <script src="../../msg/js/fr.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
    audio{
      display: none;
    }
  </style>
</head>
<body>

    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">IntTeam</a>

        <div class=" my-2 my-lg-0" id="navbarText">
          <img id="haum" src="haum.png" width="64"/>
        </div>
      </nav>
      <br/>
  <div class="container">
    <div id="blocklyDiv" style="height: 600px; width: 100%;"></div>
  </div>
  <div class="container justify-content-center">
    <center>
      <br/>
      <button onclick="showCode()"  id="showcode" type="button" class="btn btn-secondary">Show JavaScript</button>
      <button onclick="runCode()"  id="runcode"  type="button" class="btn btn-primary">Run JavaScript</button>
    </center>
<center>

<audio controls id="player1">
    <source src="1.mp3">
  </audio>
  
  <audio controls id="player2">
    <source src="2.mp3">
  </audio>
  <audio controls id="player3">
      <source src="3.mp3">
    </audio>

    <script >
  document.getElementById('haum').addEventListener('click', player3);
	document.getElementById('showcode').addEventListener('click', player2);
	document.getElementById('runcode').addEventListener('click', player1);
      var audios = [document.getElementById('player1'), document.getElementById('player2'),document.getElementById('player3')];
      function pauseAll(){
          audios[0].pause();
          audios[1].pause();
          audios[2].pause();
        
      }


    function player1() {
	    var audio = document.getElementById('player1');
	    if (audio.paused) {
        pauseAll();
	        audio.play();
	    }else{
	        audio.pause();
	    }
	}
	function player2() {

	    var audio2 = document.getElementById('player2');
	    if (audio2.paused) {
        pauseAll();
	        audio2.play();
	    }else{
	        audio2.pause();
	    }
	}
  function player3() {
  
	    var audio2 = document.getElementById('player3');
	    if (audio2.paused) { 
         pauseAll();
	        audio2.play();
	    }else{
	        audio2.pause();
	    }
	}
  </script>
  </center>
  </div>
  <xml id="toolbox" style="display: none">
    <category name="Logic" colour="%{BKY_LOGIC_HUE}">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>
    <category name="Loops" colour="%{BKY_LOOPS_HUE}">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math" colour="%{BKY_MATH_HUE}">
      <block type="math_number">
        <field name="NUM">123</field>
      </block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
    </category>
    <category name="Text" colour="%{BKY_TEXTS_HUE}">
      <block type="text"></block>
      <block type="text_length"></block>
      <block type="text_print"></block>
      <block type="variables_set"></block>
      <block type="variables_get"></block>
    </category>
    <category name="Changement des couleurs" colour="%{BKY_TEXTS_HUE}">
      <block type="changerCouleurTous"></block>
      <block type="changerCouleur"></block>
      <block type="allumer"></block>
      <block type="eteindre"></block>
      <block type="Pluie"></block>
      <block type="Spiral"></block>
      <block type="Animer"></block>
      <block type="AnimerTous"></block>
    </category>
    <category name="Bouton Poussoir" colour="%{BKY_TEXTS_HUE}">
      <block type="Message"></block>
      <block type="EtatLED"></block>
      <block type="Etatbp"></block>
      <block type="capteur_bp/switch/ledX/command/allumer"></block>
      <block type="capteur_bp/switch/ledX/command/eteindre"></block>
    </category>
    <category name="Télécommande infrarouge" colour="%{BKY_TEXTS_HUE}">
      <block type="remote/NOM_DE_LA_TOUCHE/state"></block>
    </category>
    <category name="Capteur détecteur de présence" colour="%{BKY_TEXTS_HUE}">
      <block type="presence/state"></block>
    </category>
    <category name="Capteur de distance" colour="%{BKY_TEXTS_HUE}">
      <block type="distance/value"></block>
    </category>
    <category name="Capteur atmosphérique" colour="%{BKY_TEXTS_HUE}">
      <block type="atmosphere/temperature"></block>
      <block type="atmosphere/pression"></block>
      <block type="atmosphere/humidite"></block>
      <block type="atmosphere/humidite_absolue"></block>
    </category>
  </xml>

  </xml>

  <script>

          (function (root, factory) {
      	if (typeof define === 'function' && define.amd) {
      		// AMD. Register as an anonymous module.
      		define([], factory);
      	} else if (typeof exports === 'object') {
      		// Node. Does not work with strict CommonJS, but
      		// only CommonJS-like environments that support module.exports,
      		// like Node.
      		module.exports = factory();
      	} else {
      		// Browser globals (root is window)
      		root.download = factory();
        }
      }(this, function () {

  	return function download(data, strFileName, strMimeType) {

  		var self = window, // this script is only for browsers anyway...
  			defaultMime = "application/octet-stream", // this default mime also triggers iframe downloads
  			mimeType = strMimeType || defaultMime,
  			payload = data,
  			url = !strFileName && !strMimeType && payload,
  			anchor = document.createElement("a"),
  			toString = function(a){return String(a);},
  			myBlob = (self.Blob || self.MozBlob || self.WebKitBlob || toString),
  			fileName = strFileName || "download",
  			blob,
  			reader;
  			myBlob= myBlob.call ? myBlob.bind(self) : Blob ;

  		if(String(this)==="true"){ //reverse arguments, allowing download.bind(true, "text/xml", "export.xml") to act as a callback
  			payload=[payload, mimeType];
  			mimeType=payload[0];
  			payload=payload[1];
  		}


  		if(url && url.length< 2048){ // if no filename and no mime, assume a url was passed as the only argument
  			fileName = url.split("/").pop().split("?")[0];
  			anchor.href = url; // assign href prop to temp anchor
  		  	if(anchor.href.indexOf(url) !== -1){ // if the browser determines that it's a potentially valid url path:
          		var ajax=new XMLHttpRequest();
          		ajax.open( "GET", url, true);
          		ajax.responseType = 'blob';
          		ajax.onload= function(e){
  				  download(e.target.response, fileName, defaultMime);
  				};
          		setTimeout(function(){ ajax.send();}, 0); // allows setting custom ajax headers using the return:
  			    return ajax;
  			} // end if valid url?
  		} // end if url?


  		//go ahead and download dataURLs right away
  		if(/^data\:[\w+\-]+\/[\w+\-]+[,;]/.test(payload)){

  			if(payload.length > (1024*1024*1.999) && myBlob !== toString ){
  				payload=dataUrlToBlob(payload);
  				mimeType=payload.type || defaultMime;
  			}else{
  				return navigator.msSaveBlob ?  // IE10 can't do a[download], only Blobs:
  					navigator.msSaveBlob(dataUrlToBlob(payload), fileName) :
  					saver(payload) ; // everyone else can save dataURLs un-processed
  			}

  		}//end if dataURL passed?

  		blob = payload instanceof myBlob ?
  			payload :
  			new myBlob([payload], {type: mimeType}) ;


  		function dataUrlToBlob(strUrl) {
  			var parts= strUrl.split(/[:;,]/),
  			type= parts[1],
  			decoder= parts[2] == "base64" ? atob : decodeURIComponent,
  			binData= decoder( parts.pop() ),
  			mx= binData.length,
  			i= 0,
  			uiArr= new Uint8Array(mx);

  			for(i;i<mx;++i) uiArr[i]= binData.charCodeAt(i);

  			return new myBlob([uiArr], {type: type});
  		 }

  		function saver(url, winMode){

  			if ('download' in anchor) { //html5 A[download]
  				anchor.href = url;
  				anchor.setAttribute("download", fileName);
  				anchor.className = "download-js-link";
  				anchor.innerHTML = "downloading...";
  				anchor.style.display = "none";
  				document.body.appendChild(anchor);
  				setTimeout(function() {
  					anchor.click();
  					document.body.removeChild(anchor);
  					if(winMode===true){setTimeout(function(){ self.URL.revokeObjectURL(anchor.href);}, 250 );}
  				}, 66);
  				return true;
  			}

  			// handle non-a[download] safari as best we can:
  			if(/(Version)\/(\d+)\.(\d+)(?:\.(\d+))?.*Safari\//.test(navigator.userAgent)) {
  				url=url.replace(/^data:([\w\/\-\+]+)/, defaultMime);
  				if(!window.open(url)){ // popup blocked, offer direct download:
  					if(confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")){ location.href=url; }
  				}
  				return true;
  			}

  			//do iframe dataURL download (old ch+FF):
  			var f = document.createElement("iframe");
  			document.body.appendChild(f);

  			if(!winMode){ // force a mime that will download:
  				url="data:"+url.replace(/^data:([\w\/\-\+]+)/, defaultMime);
  			}
  			f.src=url;
  			setTimeout(function(){ document.body.removeChild(f); }, 333);

  		}//end saver




  		if (navigator.msSaveBlob) { // IE10+ : (has Blob, but not a[download] or URL)
  			return navigator.msSaveBlob(blob, fileName);
  		}

  		if(self.URL){ // simple fast and modern way using Blob and URL:
  			saver(self.URL.createObjectURL(blob), true);
  		}else{
  			// handle non-Blob()+non-URL browsers:
  			if(typeof blob === "string" || blob.constructor===toString ){
  				try{
  					return saver( "data:" +  mimeType   + ";base64,"  +  self.btoa(blob)  );
  				}catch(y){
  					return saver( "data:" +  mimeType   + "," + encodeURIComponent(blob)  );
  				}
  			}

  			// Blob but not URL support:
  			reader=new FileReader();
  			reader.onload=function(e){
  				saver(this.result);
  			};
  			reader.readAsDataURL(blob);
  		}
  		return true;
  	}; /* end download() */
  }));


    var demoWorkspace = Blockly.inject('blocklyDiv',
        {media: '../../media/',
         toolbox: document.getElementById('toolbox')});
    Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
                               demoWorkspace);

    function showCode() {
      // Generate JavaScript code and display it.
      Blockly.Python.INFINITE_LOOP_TRAP = null;
      var code = Blockly.Python.workspaceToCode(demoWorkspace);
      alert(code);


    }

    function runCode() {
      // Generate JavaScript code and run it.
      window.LoopTrap = 1000;
      Blockly.Python.INFINITE_LOOP_TRAP =
          'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
      var code  = `
import paho.mqtt.client as mqtt
import time
from random import random, sample
import json
from anim import *
from comm import *

client = mqtt.Client()
client.on_message = on_message
client.connect("mpd.lan")
client.loop_start()
lampes = ["Laumio_1D9486", "Laumio_104A13", "Laumio_0FBFBF", "Laumio_104F03", "Laumio_10508F", "Laumio_10805F",  "Laumio_CD0522", "Laumio_0FC168", "Laumio_D454DB", "Laumio_107DA8"]
`;


    code= code+  "\n"


      code = code+Blockly.Python.workspaceToCode(demoWorkspace);
      code = code + "\ntime.sleep(1)\n";
      Blockly.Python.INFINITE_LOOP_TRAP = null;
      try {
        fetch("http://127.0.0.1:5000/output",{
          body:  code,
            method:"POST"});

                //eval(code);
      } catch (e) {
        alert(e);
      }
    }





  </script>

</body>
</html>
